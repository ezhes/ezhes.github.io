<!doctype html><html lang=en><head><title>Rubber Stamped: Forging SPF and DMARC to send mail as any Gmail or G Suite customer :: Ezhes — tale of the tailed z</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Due to missing verification when configuring mail routes, both Gmail&amp;rsquo;s and any G Suite customer&amp;rsquo;s strict DMARC/SPF policy may be subverted by using G Suite&amp;rsquo;s mail routing rules to relay and grant authenticity to fraudulent messages. This is notably not the same as classic mail spoofing of yesteryear in which the From header is given an arbitrary value, a technique which is easily blocked by mail servers using the Sender Policy Framework (SPF) and Domain-based Message Authentication, Reporting and Conformance (DMARC)."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://ezhes.github.io/2020/08/rubber-stamped-forging-spf-and-dmarc-to-send-mail-as-any-gmail-or-g-suite-customer/><link rel=stylesheet href=https://ezhes.github.io/assets/style.css><link rel=stylesheet href=https://ezhes.github.io/assets/pink.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://ezhes.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://ezhes.github.io/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="ezhes_"><meta name=twitter:creator content="Allison Husain"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Rubber Stamped: Forging SPF and DMARC to send mail as any Gmail or G Suite customer :: Ezhes"><meta property="og:description" content="Due to missing verification when configuring mail routes, both Gmail&amp;rsquo;s and any G Suite customer&amp;rsquo;s strict DMARC/SPF policy may be subverted by using G Suite&amp;rsquo;s mail routing rules to relay and grant authenticity to fraudulent messages. This is notably not the same as classic mail spoofing of yesteryear in which the From header is given an arbitrary value, a technique which is easily blocked by mail servers using the Sender Policy Framework (SPF) and Domain-based Message Authentication, Reporting and Conformance (DMARC)."><meta property="og:url" content="https://ezhes.github.io/2020/08/rubber-stamped-forging-spf-and-dmarc-to-send-mail-as-any-gmail-or-g-suite-customer/"><meta property="og:site_name" content="Rubber Stamped: Forging SPF and DMARC to send mail as any Gmail or G Suite customer"><meta property="og:image" content="https://ezhes.github.io/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2020-08-01 00:00:00 +0000 UTC"></head><body><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/blog><div class=logo>Ʒ</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://github.com/shusain93>Github</a></li><li><a href=https://twitter.com/ezhes_>Twitter</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://github.com/shusain93>Github</a></li><li><a href=https://twitter.com/ezhes_>Twitter</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://ezhes.github.io/2020/08/rubber-stamped-forging-spf-and-dmarc-to-send-mail-as-any-gmail-or-g-suite-customer/>Rubber Stamped: Forging SPF and DMARC to send mail as any Gmail or G Suite customer</a></h1><div class=post-meta><span class=post-date>2020-08-01</span>
<span class=post-author>::
Allison Husain</span></div><span class=post-tags>#<a href=https://ezhes.github.io/tags/security/>security</a>&nbsp;
#<a href=https://ezhes.github.io/tags/web/>web</a>&nbsp;</span><div class=post-content><div><p>Due to missing verification when configuring mail routes, both Gmail&rsquo;s and any G Suite customer&rsquo;s strict DMARC/SPF policy may be subverted by using G Suite&rsquo;s mail routing rules to relay and grant authenticity to fraudulent messages. This is notably <em>not</em> the same as <a href=https://en.wikipedia.org/wiki/Email_spoofing>classic mail spoofing</a> of yesteryear in which the <code>From</code> header is given an arbitrary value, a technique which is easily blocked by mail servers using the <a href=https://en.wikipedia.org/wiki/Sender_Policy_Framework>Sender Policy Framework (SPF)</a> and <a href=https://en.wikipedia.org/wiki/DMARC>Domain-based Message Authentication, Reporting and Conformance (DMARC)</a>. This issue is a bug unique to Google which allows an attacker to send mail as any other user or G Suite customer <strong>while still passing even the most restrictive SPF and DMARC rules.</strong></p><h2 id=a-quick-detour-into-mail-spoofing>A quick detour into mail spoofing<a href=#a-quick-detour-into-mail-spoofing class=hanchor arialabel=Anchor>&#8983;</a></h2><p>If you&rsquo;re already familiar with both SPF and DMARC, feel free to skip ahead!</p><p>Email is <em>ancient</em> technology-wise and comes from an era where the internet was nothing more than research universities and government labs. This was a point in time where if someone was misusing a computer, you&rsquo;d be able to call them or their supervisor and personally tell them off. As the internet grew and more adversaries found their way online, however, very trusting and insecure systems like email needed to evolve.</p><p>One of email&rsquo;s growing pains was that both the content and sender of messages are entirely unauthenticated by default. This means that when a message was received by a mail server, there was no clear way to be sure that the message actually originated from the address it claims. In other words, anyone at all could claim they have a message from <code>the-president@whitehouse.gov</code> and mail servers would have few formal or rigorous means to call their bluff. This of course was an enormous problem due to phishing and scams as users, for better or for worse, trust and rely on email domains to be sure they&rsquo;re talking to who they think they are.</p><p><strong>Enter SPF and DMARC</strong></p><p>The solution to this problem was to bolt on new controls which would allow the operator of a domain to inform mail servers which IP addresses are allowed to send mail from their domain. This allows administrators to give receiving mail servers the tools they need to confidently call a sender&rsquo;s bluff because they are now able to compare the sender&rsquo;s IP address (which, due to email using TCP, cannot be forged) against the authorized senders list. If the sender&rsquo;s IP isn&rsquo;t on the list, the mail server can confidently reject the message and prevent fraudulent email from hitting its users' inboxes.</p><p>The key takeaway with this protection, which will be important to this bug, is that SPF and DMARC use a sender&rsquo;s IP to protect against spoofed and fraudulent messages. This is to say that <strong>if the message originates from an approved source, it is considered legitimate under SPF and DMARC</strong>.</p><h2 id=the-bug>The bug<a href=#the-bug class=hanchor arialabel=Anchor>&#8983;</a></h2><p>While poking around on the G Suite administrator console, I noticed I could create global mail routing rules for inbound mail on my domain using the &ldquo;Default routing&rdquo; option under &ldquo;Settings for Gmail&rdquo;. These rules allowed me to, among other things, apply custom headers, modify the subject line, or change the who the email should be sent to before it is processed by the rest of Google&rsquo;s infrastructure.</p><center><img src=/blog/images/003_gsuite_spf_bypass/Envelope_Rewriting.png style=max-height:480px;max-width:100%;height:auto;width:auto></center><p>This last option, show above as &ldquo;Change envelope recipient&rdquo;, was especially interesting because it let me specify an arbitrary recipient and cause Google&rsquo;s backend to resend the email to someone else. Worryingly, the recipient value is accepted by G Suite without performing any validation to ensure that I own either the destination email address or the destination domain. This behavior immediately set off alarm bells in my head as I thought back to SPF and DMARC because this buggy feature would let me redirect incoming emails, including spoofed emails, to someone else <em>using Google&rsquo;s backend so that it no longer appears to be spoofed according to SPF and DMARC</em> if the victim also designates Google as an approved sender!</p><p>(Un)fortunately, this initial procedure of sending a spoofed email through routing rules didn&rsquo;t entirely work. While I was able to successfully get Google&rsquo;s backend to redirect and redeliver spoofed emails using domains which either didn&rsquo;t have SPF/DMARC or employed a weaker <code>soft-fail</code>/<code>quarantine</code> policy, I discovered that domains which used DMARC&rsquo;s hardened <code>reject</code> policy failed to deliver because my spoofed emails were being dropped at Google&rsquo;s border mail servers due to SPF/DMARC enforcement. This was rather disappointing because most targets who are worth impersonating use <code>p=reject</code> and so would seem not vulnerable. Was this <em>the end of my journey, the culmination of my perilous quest</em>? Fear not, dear reader, it was not!</p><p>In all seriousness, the workaround for this issue wasn&rsquo;t terribly complicated. By digging around in the G Suite admin panel a bit more, I found a section to configure what Google called an &ldquo;inbound gateway&rdquo; for my domain. <a href="https://support.google.com/a/answer/60730?hl=en">Google provides a succinct explanation of this feature in their docs</a> (emphasis mine):</p><blockquote><p>An inbound mail gateway is a server that all your incoming mail passes through. The gateway typically processes the mail in some way, such as archiving it or filtering spam. It then passes the mail to the mail server that delivers the mail to recipients.</p><p>[&mldr;]</p><p>You configure the inbound gateway setting to identify the gateway’s IP address or range of addresses. <strong>Gmail skips performing SPF checks on IP addresses included in the Gateway IPs list. If an inbound gateway is set up, the DMARC check should be done by the inbound gateway and will be skipped for messages arriving from listed hosts.</strong></p></blockquote><p>The final note on SPF and DMARC with inbound gateways was just what I was looking for. This is because it would allow me to inject messages which would otherwise be flat out rejected due to SPF and DMARC failures (such as spoofed messages) into Google&rsquo;s mail infrastructure and, consequently, have them be processed by my custom mail routing rules.</p><p><img src=/blog/images/003_gsuite_spf_bypass/Attack_Diagram.svg alt="Attack diagram"></p><p>By chaining together both the broken recipient validation in G Suite&rsquo;s mail validation rules and an inbound gateway, I was able to cause Google&rsquo;s backend to resend mail for any domain which was clearly spoofed when it was received. This is advantageous for an attacker if the the victim they intend to impersonate <em>also</em> uses Gmail or G Suite because it means <em>the message sent by Google&rsquo;s backend will pass both SPF and DMARC</em> as their domain will, by nature of using G Suite, be configured to allow Google&rsquo;s backend to send mail from their domain. Additionally, since the message is originating from Google&rsquo;s backend, it is also likely that the message will have a lower spam score and so should be filtered less often.</p><h2 id=proof-of-concept>Proof of concept<a href=#proof-of-concept class=hanchor arialabel=Anchor>&#8983;</a></h2><p>In this proof of concept, I am using my personal G Suite domain (<code>mail-relay@ezh.es</code>) to send a seemingly legitimate email from a <code>google.com</code> address to university&rsquo;s G Suite email on a domain which I do not control (<code>test@berkeley.edu</code>). I chose to send to another G Suite account to demonstrate that Google&rsquo;s strong mail filtering and anti-spam techniques do not block or detect this attack. Additionally, I chose to impersonate <code>google.com</code> because their DMARC policy is set to <code>p=reject</code> and so <a href=https://serverfault.com/a/945817/417964>any violations of SPF (regardless of the SPF policy) should result in the message simply being dropped with prejudice.</a></p><p>The following is a slightly cleaned up email from the end victim&rsquo;s perspective with various irrelevant headers removed to improve readability:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>Delivered-To</span>: <span style=color:#ae81ff>test@berkeley.edu</span>
<span style=color:#f92672>Received</span>: <span style=color:#ae81ff>by 2002:a05:6830:1db6:0:0:0:0 with SMTP id z22csp1120956oti;</span>
        <span style=color:#ae81ff>Fri, 3 Apr 2020 15:41:27 -0700 (PDT)</span>
<span style=color:#f92672>X-Received: by 2002:a17:90b:915:</span>: <span style=color:#ae81ff>with SMTP id bo21mr10227430pjb.58.1585953687701;</span>
        <span style=color:#ae81ff>Fri, 03 Apr 2020 15:41:27 -0700 (PDT)</span>
<span style=color:#f92672>ARC-Authentication-Results</span>: <span style=color:#ae81ff>i=2; mx.google.com;</span>
       <span style=color:#ae81ff>arc=pass (i=1);</span>
       <span style=color:#f92672>spf=pass (google.com</span>: <span style=color:#ae81ff>domain of not_malicious_security_research@google.com designates 209.85.220.69 as permitted sender) smtp.mailfrom=not_malicious_security_research@google.com;</span>
       <span style=color:#ae81ff>dmarc=pass (p=REJECT sp=REJECT dis=NONE) header.from=google.com</span>
<span style=color:#f92672>Return-Path</span>: <span style=color:#ae81ff>&lt;not_malicious_security_research@google.com&gt;</span>
<span style=color:#f92672>Received</span>: <span style=color:#ae81ff>from mail-sor-f69.google.com (mail-sor-f69.google.com. [209.85.220.69])</span>
        <span style=color:#ae81ff>by mx.google.com with SMTPS id o11sor13151518plk.43.2020.04.03.15.41.27</span>
        <span style=color:#ae81ff>for &lt;test@berkeley.edu&gt;</span>
        <span style=color:#ae81ff>(Google Transport Security);</span>
        <span style=color:#ae81ff>Fri, 03 Apr 2020 15:41:27 -0700 (PDT)</span>
<span style=color:#f92672>Received-SPF: pass (google.com</span>: <span style=color:#ae81ff>domain of not_malicious_security_research@google.com designates 209.85.220.69 as permitted sender) client-ip=209.85.220.69;</span>
<span style=color:#f92672>Authentication-Results</span>: <span style=color:#ae81ff>mx.google.com;</span>
       <span style=color:#ae81ff>arc=pass (i=1);</span>
       <span style=color:#f92672>spf=pass (google.com</span>: <span style=color:#ae81ff>domain of not_malicious_security_research@google.com designates 209.85.220.69 as permitted sender) smtp.mailfrom=not_malicious_security_research@google.com;</span>
       <span style=color:#ae81ff>dmarc=pass (p=REJECT sp=REJECT dis=NONE) header.from=google.com</span>
<span style=color:#f92672>X-Original-Authentication-Results</span>: <span style=color:#ae81ff>mx.google.com;</span>
       <span style=color:#f92672>spf=softfail (google.com</span>: <span style=color:#ae81ff>domain of transitioning not_malicious_security_research@google.com does not designate 64.90.62.162 as permitted sender) smtp.mailfrom=not_malicious_security_research@google.com</span>
<span style=color:#f92672>X-Received: by 2002:a17:902:690b:</span>: <span style=color:#ae81ff>with SMTP id j11mr3579141plk.236.1585953687402;</span>
        <span style=color:#ae81ff>Fri, 03 Apr 2020 15:41:27 -0700 (PDT)</span>
<span style=color:#f92672>ARC-Authentication-Results</span>: <span style=color:#ae81ff>i=1; mx.google.com;</span>
       <span style=color:#f92672>spf=softfail (google.com</span>: <span style=color:#ae81ff>domain of transitioning not_malicious_security_research@google.com does not designate 64.90.62.162 as permitted sender) smtp.mailfrom=not_malicious_security_research@google.com</span>
<span style=color:#f92672>Return-Path</span>: <span style=color:#ae81ff>&lt;not_malicious_security_research@google.com&gt;</span>
<span style=color:#f92672>Received</span>: <span style=color:#ae81ff>from chocolate.birch.relay.mailchannels.net (chocolate.birch.relay.mailchannels.net. [23.83.209.35])</span>
        <span style=color:#ae81ff>by mx.google.com with ESMTPS id s12si7121157pgq.251.2020.04.03.15.41.26</span>
        <span style=color:#ae81ff>for &lt;mail-relay@ezh.es&gt;</span>
        <span style=color:#ae81ff>(version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);</span>
        <span style=color:#ae81ff>Fri, 03 Apr 2020 15:41:26 -0700 (PDT)</span>
<span style=color:#f92672>Received-SPF: softfail (google.com</span>: <span style=color:#ae81ff>domain of transitioning not_malicious_security_research@google.com does not designate 64.90.62.162 as permitted sender) client-ip=64.90.62.162;</span>
<span style=color:#f92672>X-Sender-Id</span>: <span style=color:#ae81ff>dreamhost|x-authsender|not_malicious_security_research@google.com</span>
<span style=color:#f92672>Received</span>: <span style=color:#ae81ff>from relay.mailchannels.net (localhost [127.0.0.1]) by relay.mailchannels.net (Postfix) with ESMTP id 574F47E11C3 for &lt;mail-relay@ezh.es&gt;; Fri,</span>
  <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>Apr 2020 22:41:26 +0000 (UTC)</span>
<span style=color:#f92672>From</span>: <span style=color:#ae81ff>not_malicious_security_research@google.com</span>
<span style=color:#f92672>Content-Type</span>: <span style=color:#ae81ff>text/plain; charset=us-ascii</span>
<span style=color:#f92672>Content-Transfer-Encoding</span>: <span style=color:#ae81ff>7bit</span>
<span style=color:#f92672>Mime-Version</span>: <span style=color:#ae81ff>1.0</span> <span style=color:#ae81ff>(Mac OS X Mail 13.4 \(3608.80.23.2.2\))</span>
<span style=color:#f92672>Date</span>: <span style=color:#ae81ff>Fri, 3 Apr 2020 16:41:24 -0600</span>
<span style=color:#f92672>Subject</span>: <span style=color:#ae81ff>Google Bounce Test</span>
<span style=color:#f92672>Message-Id</span>: <span style=color:#ae81ff>&lt;500D88E3-670F-4F8C-BF72-452197BCADE9@google.com&gt;</span>
<span style=color:#f92672>X-Mailer</span>: <span style=color:#ae81ff>Apple Mail (2.3608.80.23.2.2)</span>
    
<span style=color:#ae81ff>Hey this is a spoofed email!</span>
</code></pre></div><p>The first notable header in this message is Google&rsquo;s debug ARC analysis of the message when it was received for the first time from the inbound gateway at the attacker&rsquo;s relay address (<code>mail-relay@ezh.es</code>) where it detected the SPF and DMARC failure but did not act on it due to the inbound gateway configuration:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>ARC-Authentication-Results</span>: <span style=color:#ae81ff>i=1; mx.google.com;</span>
       <span style=color:#f92672>spf=softfail (google.com</span>: <span style=color:#ae81ff>domain of transitioning not_malicious_security_research@google.com does not designate 64.90.62.162 as permitted sender) smtp.mailfrom=not_malicious_security_research@google.com</span>
</code></pre></div><p>The second is when the victim (<code>test@berkeley.edu</code>) receives the message and Google re-evaluates the message and determines that both SPF and DMARC pass with the strict <code>p=REJECT</code> policy:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>Authentication-Results</span>: <span style=color:#ae81ff>mx.google.com;</span>
       <span style=color:#ae81ff>arc=pass (i=1);</span>
       <span style=color:#f92672>spf=pass (google.com</span>: <span style=color:#ae81ff>domain of not_malicious_security_research@google.com designates 209.85.220.69 as permitted sender) smtp.mailfrom=not_malicious_security_research@google.com;</span>
       <span style=color:#ae81ff>dmarc=pass (p=REJECT sp=REJECT dis=NONE) header.from=google.com</span>
</code></pre></div><p>This results in a completely illegitimate message from a highly trusted domain with strong SPF and DMARC configurations being delivered directly to the victim&rsquo;s inbox without any sort of warning:</p><center><img src=/blog/images/003_gsuite_spf_bypass/inbox_example.png style=max-height:155px;max-width:100%;height:auto;width:auto></center><br><center><img src=/blog/images/003_gsuite_spf_bypass/gmail_pass_results.png style="max-height:406 px;max-width:100%;height:auto;width:auto"></center><h3 id=timeline>Timeline<a href=#timeline class=hanchor arialabel=Anchor>&#8983;</a></h3><ul><li>April 1st, 2020 — Initial discovery</li><li>April 3rd, 2020 — Issue reported to Google</li><li>April 16th, 2020 — Google accepts the issue, classifies it as priority 2, severity 2</li><li>April 21st, 2020 — Google marks issue as duplicate</li><li>August 1st, 2020 — <strong>No evidence of progress or attempted mitigations, issue is still reproducible using the same techniques communicated to Google 120 days earlier</strong>.</li><li>August 1st, 2020 - Google is notified of intent to publish.</li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://ezhes.github.io/2018/06/raspberry-pi-iot-air-conditioner/><span class=button__text>Raspberry Pi IOT Air Conditioner</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://ezhes.github.io/assets/main.js></script><script src=https://ezhes.github.io/assets/prism.js></script></div></body></html>